KER=`uname -r`
FINDCMD=-type f -and \( -name "*.c" -or -name "*.h" -or -name "*.cpp" -or -name "*.hpp" -or -name "*.py" \) | grep -v vmpi | grep -v "\.mod\.c" | xargs wc -l
KERNMODDIR=@ROOTDIR@/kernel

all: usr ker

usr:
	cd build && $(MAKE)

ker:
	$(MAKE) -C /lib/modules/$(KER)/build HAVE_VMPI=@HAVE_VMPI@ M=$(KERNMODDIR) KERNMODDIR=$(KERNMODDIR) modules

usr_count:
	find common user include $(FINDCMD)

ker_count:
	find common kernel $(FINDCMD)

stat count:
	cloc . || (find common kernel user include $(FINDCMD); echo "install 'cloc' for better code statistics")

clean: usr_clean ker_clean

usr_clean:
	cd build && $(MAKE) clean

ker_clean:
	$(MAKE) -C /lib/modules/$(KER)/build M=$(KERNMODDIR) clean

install: usr_install ker_install

usr_install:
	cd build && $(MAKE) install

ker_install:
	$(MAKE) -C /lib/modules/$(KER)/build INSTALL_MOD_PATH=@INSTALL_MOD_PATH@ M=$(KERNMODDIR) modules_install

depmod:
	depmod -b @INSTALL_MOD_PATH@ -a
